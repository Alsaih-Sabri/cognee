version: '3.8'

services:
  # --- COGNEE BACKEND ---
  cognee:
    build:
      context: .
      dockerfile: Dockerfile
    restart: always
    networks:
      - dokploy-network
    volumes:
      - cognee_data:/app/cognee
    environment:
      - DEBUG=${DEBUG}
      - HOST=${HOST}
      - ENVIRONMENT=${ENVIRONMENT}
      - LOG_LEVEL=${LOG_LEVEL}
      - CORS_ALLOWED_ORIGINS=https://${DOMAIN}
      - DB_PROVIDER=${DB_PROVIDER}
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=${POSTGRES_DB}
      - DB_USERNAME=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - LLM_API_KEY=${LLM_API_KEY}
      - LLM_MODEL=${LLM_MODEL}
      - LLM_PROVIDER=${LLM_PROVIDER}
      - VECTOR_DB_PROVIDER=${VECTOR_DB_PROVIDER}
      - VECTOR_DB_KEY=${VECTOR_DB_KEY}
      - ENABLE_BACKEND_ACCESS_CONTROL=${ENABLE_BACKEND_ACCESS_CONTROL}
      - ROOT_PATH=/api
    labels:
      - "traefik.enable=true"
      # Route requests starting with /api to Port 8000
      - "traefik.http.routers.cognee-api.rule=Host(`${DOMAIN}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.cognee-api.entrypoints=websecure"
      - "traefik.http.routers.cognee-api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.cognee-api.priority=20"
      # Middleware to remove /api from the URL before it reaches the backend
      - "traefik.http.middlewares.cognee-strip.stripprefix.prefixes=/api"
      # INTERNAL PATH MIDDLEWARE (Adds /v1 prefix) 
      - "traefik.http.middlewares.cognee-internal.addprefix.prefix=/v1"
      # Apply both: Strip first, then Add Internal 
      - "traefik.http.routers.cognee-api.middlewares=cognee-strip,cognee-internal"
      - "traefik.http.services.cognee-api.loadbalancer.server.port=8000"
    deploy:
      resources:
        limits:
          cpus: "${COGNEE_CPU_LIMIT}"
          memory: "${COGNEE_MEM_LIMIT}"

  # --- FRONTEND ---
  frontend:
    build:
      context: ./cognee-frontend
      dockerfile: Dockerfile
    restart: always
    networks:
      - dokploy-network
    environment:
      - NEXT_PUBLIC_BACKEND_API_URL=https://${DOMAIN}
    labels:
      - "traefik.enable=true"
      # Catch-all for the domain (Priority 10) to Port 3000
      - "traefik.http.routers.cognee-ui.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.cognee-ui.entrypoints=websecure"
      - "traefik.http.routers.cognee-ui.tls.certresolver=letsencrypt"
      - "traefik.http.routers.cognee-ui.priority=10"
      - "traefik.http.services.cognee-ui.loadbalancer.server.port=3000"

  # --- COGNEE MCP SERVER ---
  cognee-mcp:
    build:
      context: .
      dockerfile: cognee-mcp/Dockerfile
    restart: always
    networks:
      - dokploy-network
    environment:
      - TRANSPORT_MODE=${MCP_TRANSPORT_MODE}
      - API_URL=http://cognee:8000
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.cognee-mcp.rule=Host(`${DOMAIN}`) && PathPrefix(`/mcp`)"
      - "traefik.http.routers.cognee-mcp.entrypoints=websecure"
      - "traefik.http.routers.cognee-mcp.tls.certresolver=letsencrypt"
      - "traefik.http.routers.cognee-mcp.priority=15"
      - "traefik.http.middlewares.mcp-strip.stripprefix.prefixes=/mcp"
      - "traefik.http.routers.cognee-mcp.middlewares=mcp-strip"
      - "traefik.http.services.cognee-mcp.loadbalancer.server.port=8000"
    depends_on:
      - cognee

  # --- DATABASES ---
  postgres:
    image: pgvector/pgvector:pg17
    restart: always
    networks:
      - dokploy-network
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}" ]
      interval: 10s
      timeout: 5s
      retries: 5

  chromadb:
    image: chromadb/chroma:0.6.3
    restart: always
    networks:
      - dokploy-network
    environment:
      - IS_PERSISTENT=${IS_PERSISTENT}
      - CHROMA_SERVER_AUTH_CREDENTIALS=${VECTOR_DB_KEY}
    volumes:
      - chromadb_data:/chroma/chroma/

networks:
  dokploy-network:
    external: true

volumes:
  cognee_data:
  postgres_data:
  chromadb_data:
