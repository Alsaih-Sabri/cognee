version: '3.8'

services:
  # --- COGNEE BACKEND ---
  cognee:
    build:
      context: .
      dockerfile: Dockerfile
    restart: always
    networks:
      - dokploy-network
    volumes:
      - cognee_data:/app/cognee
    environment:
      - DEBUG=${DEBUG}
      - HOST=${HOST:-0.0.0.0}
      - ENVIRONMENT=${ENVIRONMENT}
      - LOG_LEVEL=${LOG_LEVEL}
      - CORS_ALLOWED_ORIGINS=https://${DOMAIN}
      # Database Configuration
      - DB_PROVIDER=${DB_PROVIDER:-postgres}
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=${POSTGRES_DB}
      - DB_USERNAME=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      # Cache Configuration (Redis)
      - CACHE_BACKEND=redis
      - CACHE_HOST=redis
      - CACHE_PORT=6379
      # LLM & Vector DB
      - LLM_API_KEY=${LLM_API_KEY}
      - LLM_MODEL=${LLM_MODEL}
      - LLM_PROVIDER=${LLM_PROVIDER}
      - VECTOR_DB_PROVIDER=${VECTOR_DB_PROVIDER}
      - VECTOR_DB_KEY=${VECTOR_DB_KEY}
      - ENABLE_BACKEND_ACCESS_CONTROL=${ENABLE_BACKEND_ACCESS_CONTROL}
      - ROOT_PATH=/api
      - ACCEPT_LOCAL_FILE_PATH=True
      - REQUIRE_AUTHENTICATION=False
      - ENABLE_BACKEND_ACCESS_CONTROL=True
    labels:
      - "traefik.enable=true"
      # Route requests starting with /api to Port 8000
      - "traefik.http.routers.cognee-api.rule=Host(`${DOMAIN}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.cognee-api.entrypoints=websecure"
      - "traefik.http.routers.cognee-api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.cognee-api.priority=20"
      # Middleware to remove /api from the URL before it reaches the backend
      - "traefik.http.middlewares.cognee-strip.stripprefix.prefixes=/api"
      # INTERNAL PATH MIDDLEWARE (Adds /v1 prefix if your app expects it, check if needed) 
      # - "traefik.http.middlewares.cognee-internal.addprefix.prefix=/v1"
      # Apply Middleware
      - "traefik.http.routers.cognee-api.middlewares=cognee-strip"
      - "traefik.http.services.cognee-api.loadbalancer.server.port=8000"
    depends_on:
      - postgres
      - redis
    deploy:
      resources:
        limits:
          cpus: "${COGNEE_CPU_LIMIT:-2.0}"
          memory: "${COGNEE_MEM_LIMIT:-4G}"

  # --- FRONTEND ---
  frontend:
    build:
      context: ./cognee-frontend
      dockerfile: Dockerfile
    restart: always
    networks:
      - dokploy-network
    environment:
      # Ensure this points to the external URL, handled by Traefik
      - NEXT_PUBLIC_BACKEND_API_URL=https://${DOMAIN}/api
      - NEXT_PUBLIC_MCP_API_URL=https://${DOMAIN}/mcp
    labels:
      - "traefik.enable=true"
      # Catch-all for the domain (Priority 10) to Port 3000
      - "traefik.http.routers.cognee-ui.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.cognee-ui.entrypoints=websecure"
      - "traefik.http.routers.cognee-ui.tls.certresolver=letsencrypt"
      - "traefik.http.routers.cognee-ui.priority=10"
      - "traefik.http.services.cognee-ui.loadbalancer.server.port=3000"

  # --- COGNEE MCP SERVER ---
  cognee-mcp:
    build:
      context: .
      dockerfile: cognee-mcp/Dockerfile
    restart: always
    networks:
      - dokploy-network
    environment:
      - TRANSPORT_MODE=${MCP_TRANSPORT_MODE:-sse}
      - TRANSPORT_MODE=${MCP_TRANSPORT_MODE:-sse}
      - API_URL=http://cognee:8000
      - CORS_ALLOWED_ORIGINS=https://${DOMAIN},http://localhost:3000
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.cognee-mcp.rule=Host(`${DOMAIN}`) && PathPrefix(`/mcp`)"
      - "traefik.http.routers.cognee-mcp.entrypoints=websecure"
      - "traefik.http.routers.cognee-mcp.tls.certresolver=letsencrypt"
      - "traefik.http.routers.cognee-mcp.priority=15"
      - "traefik.http.middlewares.mcp-strip.stripprefix.prefixes=/mcp"
      - "traefik.http.routers.cognee-mcp.middlewares=mcp-strip"
      - "traefik.http.services.cognee-mcp.loadbalancer.server.port=8000"
    depends_on:
      - cognee

  # --- DATABASES ---
  postgres:
    image: pgvector/pgvector:pg17
    restart: always
    networks:
      - dokploy-network
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for Caching/Locking
  redis:
    image: redis:7-alpine
    restart: always
    networks:
      - dokploy-network
    volumes:
      - redis_data:/data
    command: [ "redis-server", "--appendonly", "yes" ]

  chromadb:
    image: chromadb/chroma:0.6.3
    restart: always
    networks:
      - dokploy-network
    environment:
      - IS_PERSISTENT=${IS_PERSISTENT}
      - CHROMA_SERVER_AUTH_CREDENTIALS=${VECTOR_DB_KEY}
    volumes:
      - chromadb_data:/chroma/chroma/

# ⚠️ IMPORTANT: Dokploy manages the 'dokploy-network'. 
# Ensure it exists or update the network name to match your Dokploy configuration.
networks:
  dokploy-network:
    external: true

volumes:
  cognee_data:
  postgres_data:
  chromadb_data:
  redis_data:
